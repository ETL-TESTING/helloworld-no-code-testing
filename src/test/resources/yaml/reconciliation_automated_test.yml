scenarioName: "DbSqlExecutor: Load a CSV file with headers - PostgreSQL"
steps:

  - name: "test_source_count"
    url: "db://MagicExecutor"
    operation: "EXECUTE"
    request:
      sql: |
        SELECT
            COUNT(*) AS total_customer_records,
            COUNT(DISTINCT id) AS distinct_customer_ids
        FROM stagingrepdb.public.customer;
    verify:
      rows.SIZE: 1
      rows:
        - total_customer_records: 2
          distinct_customer_ids: 2

  - name: "setup_db_objects"
    url: "db://MagicExecutor"
    operation: "EXECUTE"
    request:
      sql: |
        DROP SCHEMA IF EXISTS recon CASCADE;
        CREATE SCHEMA recon;
        CREATE TABLE recon.source_customer2 (id INTEGER, email TEXT);
        ALTER DATABASE stagingrepdb SET search_path = recon, public;
    verify: { }

  - name: "load_from_csv"
    url: "db://MagicExecutor"
    operation: "LOADCSV"
    request:
      tableName: "source_customer2"
      csvSource: "data/source_customer.csv"
      withHeaders: true
    verify:
      size: 1

  - name: "Check the content of inserted rows"
    url: "db://MagicExecutor"
    operation: "EXECUTE"
    request:
      sql: |
        SELECT ID, EMAIL
        FROM stagingrepdb.recon.source_customer2
        ORDER BY ID;
    verify:
      rows.SIZE: 1
      rows:
        - id: 111
          email: "ronaldo@gmail.com"
